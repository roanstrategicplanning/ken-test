{% extends "base.html" %}

{% block content %}
<section id="hero-section" class="mb-8 h-[400px]">
    <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-2xl p-10 text-white h-full flex items-center">
        <div class="flex-1">
            <div class="inline-flex items-center bg-white/20 backdrop-blur-sm rounded-full px-4 py-1.5 text-sm mb-5">
                <i class="fa-solid fa-sparkles mr-2"></i>
                <span>Upload & Visualize in Seconds</span>
            </div>
            <h2 class="text-4xl font-bold mb-4">Transform Your Data into<br/>Beautiful Charts</h2>
            <p class="text-blue-100 text-lg mb-8 max-w-2xl">Upload Excel or CSV files and instantly generate interactive charts, graphs, and visualizations. No coding required.</p>
            <div class="flex items-center space-x-4">
                <button onclick="document.getElementById('file-input').click()" class="bg-white text-blue-600 px-8 py-3.5 rounded-xl font-semibold hover:shadow-2xl transition-all">
                    <i class="fa-solid fa-arrow-up mr-2"></i>Upload File
                </button>
            </div>
        </div>
        <div class="hidden lg:block ml-8">
            <div class="relative">
                <div class="relative w-64 h-64">
                    <svg viewBox="0 0 200 200" class="w-full h-full">
                        <circle cx="100" cy="100" r="80" fill="white" opacity="0.3" />
                        <path d="M 100 100 L 100 20 A 80 80 0 0 1 180 100 Z" fill="white" opacity="0.5" />
                        <path d="M 100 100 L 180 100 A 80 80 0 0 1 100 180 Z" fill="white" opacity="0.4" />
                        <path d="M 100 100 L 100 180 A 80 80 0 0 1 20 100 Z" fill="white" opacity="0.3" />
                        <path d="M 100 100 L 20 100 A 80 80 0 0 1 100 20 Z" fill="white" opacity="0.6" />
                        <circle cx="100" cy="100" r="40" fill="white" opacity="0.8" />
                    </svg>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="upload-section" class="mb-8">
    <div id="upload-area" class="bg-white rounded-2xl shadow-sm border-2 border-dashed border-gray-300 hover:border-blue-500 transition-colors">
        <div class="p-12 text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4">
                    <i class="fa-solid fa-cloud-arrow-up text-blue-600 text-3xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-gray-900 mb-2">Upload Your Data File</h3>
                <p class="text-gray-600">Drag and drop your Excel (.xlsx, .xls) or CSV file here, or click to browse.</p>
            </div>
            <form id="upload-form" enctype="multipart/form-data" class="mb-6">
                <input type="file" id="file-input" name="file" accept=".xlsx,.xls,.csv" class="hidden" required>
                <div class="flex items-center justify-center space-x-4 mb-6">
                    <button type="button" onclick="document.getElementById('file-input').click()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3.5 rounded-xl font-semibold hover:shadow-lg transition-shadow">
                        <i class="fa-solid fa-folder-open mr-2"></i>Choose File
                    </button>
                    <button type="button" id="import-url-btn" class="bg-white border-2 border-gray-300 text-gray-700 px-8 py-3.5 rounded-xl font-semibold hover:bg-gray-50 transition-colors">
                        <i class="fa-brands fa-google-drive mr-2"></i>Import from Google Sheet
                    </button>
                    {% if current_filename %}
                    <button type="button" id="reset-btn" class="border-2 border-red-300 text-red-700 px-8 py-3.5 rounded-xl font-semibold hover:bg-red-50 transition-colors">
                        <i class="fa-solid fa-trash mr-2"></i>Clear File
                    </button>
                    {% endif %}
                </div>
            </form>
            {% if current_filename %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-center">
                    <i class="fa-solid fa-check-circle text-green-600 mr-2"></i>
                    <span class="text-green-800">Loaded: <strong>{{ current_filename }}</strong></span>
                </div>
            </div>
            {% endif %}
            <div class="flex items-center justify-center space-x-6 text-sm text-gray-500">
                <div class="flex items-center">
                    <i class="fa-solid fa-file-excel text-green-600 mr-2"></i>
                    <span>Excel (.xlsx, .xls)</span>
                </div>
                <div class="flex items-center">
                    <i class="fa-solid fa-file-csv text-blue-600 mr-2"></i>
                    <span>CSV (.csv)</span>
                </div>
                <div class="flex items-center">
                    <i class="fa-solid fa-circle-info text-gray-400 mr-2"></i>
                    <span>Max 50MB</span>
                </div>
            </div>
        </div>
    </div>
</section>

{% if recent_uploads and recent_uploads|length > 0 %}
<section id="recent-uploads-section" class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-xl font-semibold text-gray-900">Recent Uploads</h3>
            <p class="text-sm text-gray-500 mt-1">Your recently processed files.</p>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for upload in recent_uploads[:3] %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center space-x-3">
                    {% if upload.is_excel %}
                    <div class="bg-green-100 p-3 rounded-lg">
                        <i class="fa-solid fa-file-excel text-green-600 text-xl"></i>
                    </div>
                    {% else %}
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <i class="fa-solid fa-file-csv text-blue-600 text-xl"></i>
                    </div>
                    {% endif %}
                    <div>
                        <h4 class="font-semibold text-gray-900 text-sm">{{ upload.filename }}</h4>
                        <p class="text-xs text-gray-500">{{ upload.time_ago }}</p>
                    </div>
                </div>
            </div>
            <div class="space-y-2 mb-4">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">{{ upload.row_count }} rows, {{ upload.column_count }} columns</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">{{ upload.file_size_mb }} MB</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if current_filename %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h3 class="text-xl font-semibold text-gray-900">{{ current_filename }}</h3>
        <p class="text-sm text-gray-500 mt-1">File details and statistics.</p>
    </div>
</div>
{% endif %}

{% if error %}
<section id="error-section" class="mb-8">
    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
        <div class="flex items-center">
            <i class="fa-solid fa-exclamation-circle text-red-600 text-2xl mr-4"></i>
            <div>
                <h3 class="text-lg font-semibold text-red-900 mb-1">Error Loading Data</h3>
                <p class="text-red-700">{{ error }}</p>
            </div>
        </div>
    </div>
</section>
{% elif has_data %}
<section id="data-stats-section" class="mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-blue-100 rounded-full mb-4">
                <i class="fa-solid fa-table text-blue-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Total Rows</h4>
            <p class="text-3xl font-bold text-blue-600">{{ total_rows }}</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-green-100 rounded-full mb-4">
                <i class="fa-solid fa-columns text-green-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Total Columns</h4>
            <p class="text-3xl font-bold text-green-600">{{ total_columns }}</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-purple-100 rounded-full mb-4">
                <i class="fa-solid fa-chart-bar text-purple-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Numeric Columns</h4>
            <p class="text-3xl font-bold text-purple-600">{{ numeric_columns }}</p>
        </div>
    </div>
</section>

<section id="chart-preview-section" class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-xl font-semibold text-gray-900">Generated Visualizations</h3>
            <p class="text-sm text-gray-500 mt-1">From {{ current_filename if current_filename else 'your uploaded file' }}</p>
        </div>
        <div class="flex items-center space-x-3">
            <button id="export-all-btn" class="flex items-center space-x-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fa-solid fa-download text-sm"></i>
                <span class="text-sm font-medium">Export All</span>
            </button>
            <button class="flex items-center space-x-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fa-solid fa-sliders text-sm"></i>
                <span class="text-sm font-medium">Customize</span>
            </button>
        </div>
    </div>
    
    {% if numeric_cols|length >= 1 %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            {% if columns|length >= 2 %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h4 class="font-semibold text-gray-900 mb-4">Line Chart</h4>
                <div id="line-chart" style="height: 300px"></div>
            </div>
            {% endif %}

            {% if categorical_cols|length >= 1 and numeric_cols|length >= 1 %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h4 class="font-semibold text-gray-900 mb-4">Pie Chart</h4>
                <div id="pie-chart" style="height: 300px"></div>
            </div>
            {% endif %}

            {% if columns|length >= 2 %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h4 class="font-semibold text-gray-900 mb-4">Bar Chart</h4>
                <div id="bar-chart" style="height: 300px"></div>
            </div>
            {% endif %}

            {% if columns|length >= 2 %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h4 class="font-semibold text-gray-900 mb-4">Bar Chart 2</h4>
                <div id="bar-chart-2" style="height: 300px"></div>
            </div>
            {% endif %}
        </div>

        <!-- Chart Customization Options -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Chart Customization Options</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Chart Type</label>
                    <div class="flex flex-wrap gap-2">
                        <button id="chart-type-line" class="chart-type-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">Line Chart</button>
                        <button id="chart-type-bar" class="chart-type-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">Bar Chart</button>
                        <button id="chart-type-pie" class="chart-type-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">Pie Chart</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Color Scheme</label>
                    <div class="flex flex-wrap gap-2">
                        <button id="color-blue" class="color-scheme-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">Blue Gradient</button>
                        <button id="color-purple" class="color-scheme-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">Purple</button>
                        <button id="color-rainbow" class="color-scheme-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">Rainbow</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Data Range</label>
                    <div class="flex flex-wrap gap-2">
                        <button id="range-all" class="data-range-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">All Data</button>
                        <button id="range-30days" class="data-range-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">Last 30 Days</button>
                        <button id="range-custom" class="data-range-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">Custom</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Advanced Options</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="option-data-labels" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Show data labels</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="option-grid-lines" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Show grid lines</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="option-animations" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Enable animations</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="option-tooltips" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Interactive tooltips</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end space-x-3 mt-6">
                <button id="reset-customization-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    Reset to Default
                </button>
                <button id="apply-customization-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    Apply Changes
                </button>
            </div>
        </div>
    {% else %}
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-6">
        <div class="flex items-center">
            <i class="fa-solid fa-exclamation-triangle text-amber-600 text-2xl mr-4"></i>
            <div>
                <h3 class="text-lg font-semibold text-amber-900 mb-1">No Numeric Data</h3>
                <p class="text-amber-700">No numeric columns found for charting. Please upload an Excel file with numeric data.</p>
            </div>
        </div>
    </div>
    {% endif %}
</section>

<section id="data-table-section" class="mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Raw Data Preview</h3>
        </div>
        <div id="excel-container" class="excel-wrapper">
            <div class="excel-table-container">
                {{ data_html|safe }}
            </div>
        </div>
    </div>
</section>
{% endif %}

<section id="features-section" class="mb-8">
    <div class="text-center mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-2">Powerful Features</h3>
        <p class="text-gray-600">Everything you need to transform data into insights.</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-blue-100 rounded-full mb-4">
                <i class="fa-solid fa-bolt text-blue-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Instant Processing</h4>
            <p class="text-sm text-gray-600">Upload and visualize your data in seconds with our fast processing engine.</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-green-100 rounded-full mb-4">
                <i class="fa-solid fa-chart-bar text-green-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">20+ Chart Types</h4>
            <p class="text-sm text-gray-600">Choose from a wide variety of chart types to best represent your data.</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-purple-100 rounded-full mb-4">
                <i class="fa-solid fa-palette text-purple-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Full Customization</h4>
            <p class="text-sm text-gray-600">Customize colors, fonts, labels, and styles to match your brand.</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-orange-100 rounded-full mb-4">
                <i class="fa-solid fa-share-nodes text-orange-600 text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-2">Easy Sharing</h4>
            <p class="text-sm text-gray-600">Export and share your visualizations in multiple formats instantly.</p>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    /* Excel-like styling */
    .excel-wrapper {
        border: 1px solid #d1d5db;
        border-radius: 4px;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .excel-table-container {
        overflow: auto;
        max-height: 600px;
        position: relative;
    }

    #data-table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 13px;
        background: #ffffff;
        margin: 0;
    }

    /* Excel-like header row */
    #data-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f3f4f6;
    }

    #data-table thead th {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        text-align: left;
        font-weight: 600;
        color: #1f2937;
        white-space: nowrap;
        position: relative;
        min-width: 100px;
    }

    #data-table thead th:first-child {
        background: #e5e7eb;
        border-left: 2px solid #9ca3af;
        font-weight: 700;
        text-align: center;
        min-width: 50px;
        width: 50px;
    }

    /* Excel-like data cells */
    #data-table tbody td {
        border: 1px solid #e5e7eb;
        padding: 6px 12px;
        background: #ffffff;
        color: #111827;
        white-space: nowrap;
        min-width: 100px;
    }

    #data-table tbody tr:nth-child(even) td {
        background: #f9fafb;
    }

    #data-table tbody tr:hover td {
        background: #eff6ff;
    }

    #data-table tbody td:first-child {
        background: #f3f4f6;
        border-left: 2px solid #9ca3af;
        text-align: center;
        font-weight: 600;
        color: #6b7280;
        min-width: 50px;
        width: 50px;
        position: sticky;
        left: 0;
        z-index: 5;
    }

    #data-table thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 15;
    }

    /* Excel-like scrollbar */
    .excel-table-container::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }

    .excel-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border: 1px solid #e5e7eb;
    }

    .excel-table-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
        border: 1px solid #94a3b8;
    }

    .excel-table-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Excel-like corner cell */
    #data-table thead th:first-child {
        background: #e5e7eb;
        border-top: 2px solid #9ca3af;
        border-left: 2px solid #9ca3af;
    }

    /* Cell selection effect */
    #data-table tbody td:focus,
    #data-table tbody td:active,
    #data-table tbody td.selected,
    #data-table thead th.selected {
        outline: 2px solid #3b82f6;
        outline-offset: -2px;
        background: #dbeafe !important;
        box-shadow: inset 0 0 0 1px #3b82f6;
    }

    /* Column letter indicators (optional enhancement) */
    .excel-column-header {
        display: inline-block;
        width: 100%;
        text-align: center;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Drag and drop functionality
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    if (uploadArea && fileInput) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('border-blue-500', 'bg-blue-50');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
            }, false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    }

    // Handle file upload
    document.getElementById('file-input')?.addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
            const formData = new FormData();
            formData.append('file', e.target.files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Error uploading file: ' + error.message);
            }
        }
    });

    // Handle reset
    document.getElementById('reset-btn')?.addEventListener('click', async function() {
        if (confirm('Are you sure you want to clear the current file?')) {
            try {
                const response = await fetch('/reset', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (error) {
                alert('Error resetting: ' + error.message);
            }
        }
    });

    // Handle Google Sheets import
    document.getElementById('import-url-btn')?.addEventListener('click', async function() {
        const url = prompt('Enter Google Sheets URL:\n\nMake sure the sheet is published or shared with "Anyone with the link can view"');
        
        if (!url) {
            return; // User cancelled
        }
        
        // Validate it's a Google Sheets URL
        if (!url.includes('docs.google.com/spreadsheets')) {
            alert('Error: Please enter a valid Google Sheets URL (must contain docs.google.com/spreadsheets)');
            return;
        }
        
        // Show loading state
        const btn = document.getElementById('import-url-btn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Importing...';
        
        try {
            const response = await fetch('/import-google-sheet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            });
            const data = await response.json();
            
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        } catch (error) {
            alert('Error importing Google Sheet: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    });

    // Chart generation functions
    {% if has_data and numeric_cols|length >= 1 %}
    
    // Apply customizations to a single chart
    function applyCustomizationsToChart(chartId, chartData) {
        // Default color schemes (in case colorSchemes is not defined yet)
        const defaultColorSchemes = {
            blue: ['#3B82F6', '#2563EB', '#1D4ED8', '#1E40AF', '#1E3A8A'],
            purple: ['#8B5CF6', '#7C3AED', '#6D28D9', '#5B21B6', '#4C1D95'],
            rainbow: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899']
        };
        
        // Get current customization state (will be defined later, but we need defaults)
        const customization = (typeof chartCustomization !== 'undefined' && chartCustomization) || {
            chartType: 'line',
            colorScheme: 'blue',
            dataRange: 'all',
            showDataLabels: false,
            showGridLines: false,
            enableAnimations: true,
            interactiveTooltips: true
        };
        
        const schemes = (typeof colorSchemes !== 'undefined' && colorSchemes) || defaultColorSchemes;
        const colors = schemes[customization.colorScheme] || schemes.blue;
        const data = Array.isArray(chartData.data) ? chartData.data : [chartData.data];
        const layout = chartData.layout || {};
        
        // Apply color scheme to data traces
        const customizedData = data.map((trace, index) => {
            const newTrace = { ...trace };
            const color = colors[index % colors.length];
            
            // Apply colors based on trace type
            if (newTrace.type === 'bar') {
                newTrace.marker = { ...newTrace.marker, color: color };
            } else if (newTrace.type === 'scatter' && newTrace.mode && newTrace.mode.includes('lines')) {
                newTrace.line = { ...newTrace.line, color: color };
            } else if (newTrace.type === 'pie') {
                newTrace.marker = { ...newTrace.marker, colors: colors };
            }
            
            // Apply data labels
            if (customization.showDataLabels) {
                if (newTrace.type === 'pie') {
                    newTrace.textposition = 'auto';
                } else {
                    newTrace.textposition = 'auto';
                    if (newTrace.y) {
                        newTrace.text = newTrace.y.map(v => v.toString());
                    }
                }
            } else {
                newTrace.textposition = 'none';
                if (newTrace.type !== 'pie') {
                    newTrace.text = [];
                }
            }
            
            return newTrace;
        });
        
        // Apply layout customizations
        const customizedLayout = {
            ...layout,
            xaxis: {
                ...layout.xaxis,
                showgrid: customization.showGridLines,
                gridcolor: customization.showGridLines ? '#E5E7EB' : 'transparent'
            },
            yaxis: {
                ...layout.yaxis,
                showgrid: customization.showGridLines,
                gridcolor: customization.showGridLines ? '#E5E7EB' : 'transparent'
            }
        };
        
        return {
            data: customizedData,
            layout: customizedLayout
        };
    }
    
    async function updateBarChart() {
        const xSelect = document.getElementById('bar-x-select');
        const ySelect = document.getElementById('bar-y-select');
        
        if (!xSelect || !ySelect) {
            // If select elements don't exist, use default values from columns
            if (columns.length >= 2 && numericCols.length > 0) {
                const xCol = columns[0];
                const yCol = numericCols[0];
                try {
                    const response = await fetch('/chart/bar', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({x_col: xCol, y_col: yCol})
                    });
                    const data = await response.json();
                    if (data.chart) {
                        const chartData = JSON.parse(data.chart);
                        const customizedData = applyCustomizationsToChart('bar-chart', chartData);
                        Plotly.newPlot('bar-chart', customizedData.data, customizedData.layout, { responsive: true, displayModeBar: false });
                    } else if (data.error) {
                        console.error('Chart error:', data.error);
                    }
                } catch (error) {
                    console.error('Error loading bar chart:', error);
                }
            }
            return;
        }
        
        const xCol = xSelect.value;
        const yCol = ySelect.value;
        
        try {
            const response = await fetch('/chart/bar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({x_col: xCol, y_col: yCol})
            });
            const data = await response.json();
            if (data.chart) {
                const chartData = JSON.parse(data.chart);
                const customizedData = applyCustomizationsToChart('bar-chart', chartData);
                Plotly.newPlot('bar-chart', customizedData.data, customizedData.layout, { responsive: true, displayModeBar: false });
            } else if (data.error) {
                console.error('Chart error:', data.error);
            }
        } catch (error) {
            console.error('Error loading bar chart:', error);
        }
    }

    async function updateLineChart() {
        const lineCol = document.getElementById('line-select')?.value || (numericCols && numericCols[0]);
        if (!lineCol) return;
        
        try {
            const response = await fetch('/chart/line', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({line_col: lineCol})
            });
            const data = await response.json();
            if (data.chart) {
                const chartData = JSON.parse(data.chart);
                const customizedData = applyCustomizationsToChart('line-chart', chartData);
                Plotly.newPlot('line-chart', customizedData.data, customizedData.layout, { responsive: true, displayModeBar: false });
            } else if (data.error) {
                console.error('Chart error:', data.error);
            }
        } catch (error) {
            console.error('Error loading line chart:', error);
        }
    }

    async function updatePieChart() {
        const catSelect = document.getElementById('pie-cat-select');
        const valSelect = document.getElementById('pie-val-select');
        
        if (!catSelect || !valSelect) {
            // If select elements don't exist, use default values from columns
            if (categoricalCols.length > 0 && numericCols.length > 0) {
                const catCol = categoricalCols[0];
                const valCol = numericCols[0];
                try {
                    const response = await fetch('/chart/pie', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({cat_col: catCol, val_col: valCol})
                    });
                    const data = await response.json();
                    if (data.chart) {
                        const chartData = JSON.parse(data.chart);
                        const customizedData = applyCustomizationsToChart('pie-chart', chartData);
                        Plotly.newPlot('pie-chart', customizedData.data, customizedData.layout, { responsive: true, displayModeBar: false });
                    } else if (data.error) {
                        console.error('Chart error:', data.error);
                    }
                } catch (error) {
                    console.error('Error loading pie chart:', error);
                }
            }
            return;
        }
        
        const catCol = catSelect.value;
        const valCol = valSelect.value;
        
        try {
            const response = await fetch('/chart/pie', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cat_col: catCol, val_col: valCol})
            });
            const data = await response.json();
            if (data.chart) {
                const chartData = JSON.parse(data.chart);
                const customizedData = applyCustomizationsToChart('pie-chart', chartData);
                Plotly.newPlot('pie-chart', customizedData.data, customizedData.layout, { responsive: true, displayModeBar: false });
            } else if (data.error) {
                console.error('Chart error:', data.error);
            }
        } catch (error) {
            console.error('Error loading pie chart:', error);
        }
    }

    // Initialize charts on page load
    const numericCols = {{ numeric_cols|tojson if numeric_cols else '[]' }};
    const columns = {{ columns|tojson if columns else '[]' }};
    const categoricalCols = {{ categorical_cols|tojson if categorical_cols else '[]' }};

    // Auto-generate charts with default selections
    if (numericCols.length > 0) {
        // Line chart
        if (numericCols.length > 0) {
            updateLineChart();
        }

        // Pie chart
        if (categoricalCols.length > 0 && numericCols.length > 0) {
            updatePieChart();
        }

        // Bar charts
        if (columns.length >= 2) {
            updateBarChart();
            // Second bar chart
            if (columns.length >= 2 && numericCols.length > 0) {
                setTimeout(() => {
                    const xCol = columns[0];
                    const yCol = numericCols[0];
                    fetch('/chart/bar', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({x_col: xCol, y_col: yCol})
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.chart) {
                            const chartData = JSON.parse(data.chart);
                            const customizedData = applyCustomizationsToChart('bar-chart-2', chartData);
                            Plotly.newPlot('bar-chart-2', customizedData.data, customizedData.layout, { responsive: true, displayModeBar: false });
                        }
                    })
                    .catch(err => console.error('Error loading second bar chart:', err));
                }, 500);
            }
        }
    }

    // Add event listeners if select elements exist
    {% if columns|length >= 2 %}
    document.getElementById('bar-x-select')?.addEventListener('change', updateBarChart);
    document.getElementById('bar-y-select')?.addEventListener('change', updateBarChart);
    {% endif %}

    document.getElementById('line-select')?.addEventListener('change', updateLineChart);

    {% if categorical_cols|length >= 1 %}
    document.getElementById('pie-cat-select')?.addEventListener('change', updatePieChart);
    document.getElementById('pie-val-select')?.addEventListener('change', updatePieChart);
    {% endif %}
    {% endif %}

    // Chart Customization State
    let chartCustomization = {
        chartType: 'line', // 'line', 'bar', 'pie'
        colorScheme: 'blue', // 'blue', 'purple', 'rainbow'
        dataRange: 'all', // 'all', '30days', 'custom'
        showDataLabels: false,
        showGridLines: false,
        enableAnimations: true,
        interactiveTooltips: true
    };

    // Color schemes
    const colorSchemes = {
        blue: ['#3B82F6', '#2563EB', '#1D4ED8', '#1E40AF', '#1E3A8A'],
        purple: ['#8B5CF6', '#7C3AED', '#6D28D9', '#5B21B6', '#4C1D95'],
        rainbow: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899']
    };

    // Update button active states
    function updateButtonStates() {
        // Chart type buttons
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        });
        const activeChartType = document.getElementById(`chart-type-${chartCustomization.chartType}`);
        if (activeChartType) {
            activeChartType.classList.remove('bg-gray-100', 'text-gray-700');
            activeChartType.classList.add('bg-blue-600', 'text-white');
        }

        // Color scheme buttons
        document.querySelectorAll('.color-scheme-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        });
        const activeColor = document.getElementById(`color-${chartCustomization.colorScheme}`);
        if (activeColor) {
            activeColor.classList.remove('bg-gray-100', 'text-gray-700');
            activeColor.classList.add('bg-blue-600', 'text-white');
        }

        // Data range buttons
        document.querySelectorAll('.data-range-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        });
        const activeRange = document.getElementById(`range-${chartCustomization.dataRange}`);
        if (activeRange) {
            activeRange.classList.remove('bg-gray-100', 'text-gray-700');
            activeRange.classList.add('bg-blue-600', 'text-white');
        }
    }

    // Re-render all charts with customizations
    function applyCustomizationsToAllCharts() {
        const chartIds = ['line-chart', 'pie-chart', 'bar-chart', 'bar-chart-2'];
        const colors = colorSchemes[chartCustomization.colorScheme] || colorSchemes.blue;
        
        chartIds.forEach((chartId, chartIndex) => {
            const chartElement = document.getElementById(chartId);
            if (!chartElement) return;
            
            // Check if chart has been rendered (has Plotly data)
            const plotlyData = chartElement.data;
            if (!plotlyData || plotlyData.length === 0) return;

            // Handle pie charts differently
            if (plotlyData[0] && plotlyData[0].type === 'pie') {
                // For pie charts, update marker colors
                Plotly.restyle(chartElement, {
                    'marker.colors': [colors]
                });
                
                // Update text position for labels
                Plotly.restyle(chartElement, {
                    'textposition': chartCustomization.showDataLabels ? 'auto' : 'none'
                });
            } else {
                // For other chart types (bar, line, etc.)
                plotlyData.forEach((trace, traceIndex) => {
                    const color = colors[traceIndex % colors.length];
                    const updates = {};
                    
                    // Update colors based on chart type
                    if (trace.type === 'bar') {
                        updates['marker.color'] = color;
                    } else if (trace.type === 'scatter' && trace.mode && trace.mode.includes('lines')) {
                        updates['line.color'] = color;
                    }
                    
                    // Update data labels
                    if (chartCustomization.showDataLabels) {
                        updates['textposition'] = 'auto';
                        if (trace.y) {
                            updates['text'] = trace.y.map(v => v.toString());
                        }
                    } else {
                        updates['textposition'] = 'none';
                        updates['text'] = [];
                    }
                    
                    // Apply updates to this trace
                    if (Object.keys(updates).length > 0) {
                        Plotly.restyle(chartElement, updates, [traceIndex]);
                    }
                });
                
                // Update layout (grid lines, etc.) - only for non-pie charts
                Plotly.relayout(chartElement, {
                    'xaxis.showgrid': chartCustomization.showGridLines,
                    'yaxis.showgrid': chartCustomization.showGridLines,
                    'xaxis.gridcolor': chartCustomization.showGridLines ? '#E5E7EB' : 'transparent',
                    'yaxis.gridcolor': chartCustomization.showGridLines ? '#E5E7EB' : 'transparent'
                });
            }
        });
    }

    // Initialize customization controls
    function initCustomizationControls() {
        // Chart type buttons
        document.getElementById('chart-type-line')?.addEventListener('click', () => {
            chartCustomization.chartType = 'line';
            updateButtonStates();
        });
        document.getElementById('chart-type-bar')?.addEventListener('click', () => {
            chartCustomization.chartType = 'bar';
            updateButtonStates();
        });
        document.getElementById('chart-type-pie')?.addEventListener('click', () => {
            chartCustomization.chartType = 'pie';
            updateButtonStates();
        });

        // Color scheme buttons
        document.getElementById('color-blue')?.addEventListener('click', () => {
            chartCustomization.colorScheme = 'blue';
            updateButtonStates();
        });
        document.getElementById('color-purple')?.addEventListener('click', () => {
            chartCustomization.colorScheme = 'purple';
            updateButtonStates();
        });
        document.getElementById('color-rainbow')?.addEventListener('click', () => {
            chartCustomization.colorScheme = 'rainbow';
            updateButtonStates();
        });

        // Data range buttons
        document.getElementById('range-all')?.addEventListener('click', () => {
            chartCustomization.dataRange = 'all';
            updateButtonStates();
        });
        document.getElementById('range-30days')?.addEventListener('click', () => {
            chartCustomization.dataRange = '30days';
            updateButtonStates();
            alert('Note: "Last 30 Days" filter requires date columns. Currently showing all data.');
        });
        document.getElementById('range-custom')?.addEventListener('click', () => {
            chartCustomization.dataRange = 'custom';
            updateButtonStates();
            alert('Note: Custom range selection is not yet implemented. Currently showing all data.');
        });

        // Checkboxes
        document.getElementById('option-data-labels')?.addEventListener('change', (e) => {
            chartCustomization.showDataLabels = e.target.checked;
        });
        document.getElementById('option-grid-lines')?.addEventListener('change', (e) => {
            chartCustomization.showGridLines = e.target.checked;
        });
        document.getElementById('option-animations')?.addEventListener('change', (e) => {
            chartCustomization.enableAnimations = e.target.checked;
        });
        document.getElementById('option-tooltips')?.addEventListener('change', (e) => {
            chartCustomization.interactiveTooltips = e.target.checked;
        });

        // Reset button
        document.getElementById('reset-customization-btn')?.addEventListener('click', () => {
            chartCustomization = {
                chartType: 'line',
                colorScheme: 'blue',
                dataRange: 'all',
                showDataLabels: false,
                showGridLines: false,
                enableAnimations: true,
                interactiveTooltips: true
            };
            
            // Update UI
            document.getElementById('option-data-labels').checked = false;
            document.getElementById('option-grid-lines').checked = false;
            document.getElementById('option-animations').checked = true;
            document.getElementById('option-tooltips').checked = true;
            
            updateButtonStates();
            applyCustomizationsToAllCharts();
        });

        // Apply button
        document.getElementById('apply-customization-btn')?.addEventListener('click', () => {
            applyCustomizationsToAllCharts();
            
            // Show feedback
            const btn = document.getElementById('apply-customization-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Applied!';
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 1500);
        });

        // Initialize button states
        updateButtonStates();
    }

    // Initialize customization controls when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCustomizationControls);
    } else {
        initCustomizationControls();
    }

    // Export All functionality
    document.getElementById('export-all-btn')?.addEventListener('click', function() {
        const chartIds = ['line-chart', 'pie-chart', 'bar-chart', 'bar-chart-2'];
        const chartNames = {
            'line-chart': 'Line Chart',
            'pie-chart': 'Pie Chart',
            'bar-chart': 'Bar Chart',
            'bar-chart-2': 'Bar Chart 2'
        };
        
        // Filter to only charts that exist on the page and have been rendered
        const existingCharts = chartIds.filter(id => {
            const element = document.getElementById(id);
            // Check if element exists and has been rendered by Plotly (has children or plotly graph)
            return element && element.children.length > 0;
        });
        
        if (existingCharts.length === 0) {
            alert('No charts available to export. Please wait for charts to load.');
            return;
        }
        
        // Show loading state
        const btn = document.getElementById('export-all-btn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-sm"></i><span class="text-sm font-medium">Exporting...</span>';
        
        // Export each chart with a delay between downloads to prevent browser blocking
        let exportedCount = 0;
        existingCharts.forEach((chartId, index) => {
            setTimeout(() => {
                const chartName = chartNames[chartId] || chartId;
                const chartElement = document.getElementById(chartId);
                
                try {
                    // Use Plotly's downloadImage function
                    Plotly.downloadImage(chartElement, {
                        format: 'png',
                        width: 1200,
                        height: 600,
                        filename: chartName.replace(/\s+/g, '_').toLowerCase()
                    });
                    exportedCount++;
                    
                    // Reset button state after last export
                    if (exportedCount === existingCharts.length) {
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = originalContent;
                            alert(`Successfully exported ${exportedCount} chart(s)!`);
                        }, 500);
                    }
                } catch (error) {
                    console.error(`Error exporting ${chartName}:`, error);
                    exportedCount++;
                    
                    // Reset button state even if there was an error
                    if (exportedCount === existingCharts.length) {
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = originalContent;
                            alert(`Exported ${exportedCount} chart(s) with some errors. Check console for details.`);
                        }, 500);
                    }
                }
            }, index * 600); // 600ms delay between each export
        });
    });

    // Excel-like table enhancements
    function enhanceExcelTable() {
        const table = document.getElementById('data-table');
        if (!table) return;

        // Add row numbers to first column
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach((row, index) => {
            const firstCell = row.querySelector('td:first-child');
            if (firstCell) {
                firstCell.textContent = index + 1;
                firstCell.setAttribute('data-row-number', index + 1);
            }
        });

        // Add column letters to header
        const headerRow = table.querySelector('thead tr');
        if (headerRow) {
            const headers = headerRow.querySelectorAll('th');
            headers.forEach((header, index) => {
                if (index === 0) {
                    // First header is for row numbers
                    header.textContent = '';
                    header.setAttribute('data-column-letter', '');
                } else {
                    // Convert column index to Excel column letter (A, B, C, ..., Z, AA, AB, etc.)
                    const columnLetter = indexToExcelColumn(index);
                    const originalText = header.textContent;
                    header.innerHTML = `<span class="excel-column-header">${columnLetter}</span><br><span style="font-weight: 400; font-size: 11px; color: #6b7280;">${originalText}</span>`;
                    header.setAttribute('data-column-letter', columnLetter);
                }
            });
        }

        // Make cells look more interactive
        const cells = table.querySelectorAll('td, th');
        cells.forEach(cell => {
            cell.setAttribute('tabindex', '0');
            cell.style.cursor = 'cell';
            
            // Add click handler for cell selection
            cell.addEventListener('click', function() {
                // Remove previous selection
                table.querySelectorAll('td.selected, th.selected').forEach(c => {
                    c.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });

        // Add keyboard navigation
        table.addEventListener('keydown', function(e) {
            const selected = table.querySelector('.selected');
            if (!selected) return;

            let newCell = null;
            const row = selected.parentElement;
            const cells = Array.from(row.querySelectorAll('td, th'));
            const currentIndex = cells.indexOf(selected);

            switch(e.key) {
                case 'ArrowRight':
                    e.preventDefault();
                    if (currentIndex < cells.length - 1) {
                        newCell = cells[currentIndex + 1];
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (currentIndex > 0) {
                        newCell = cells[currentIndex - 1];
                    }
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        const nextCells = Array.from(nextRow.querySelectorAll('td, th'));
                        if (nextCells[currentIndex]) {
                            newCell = nextCells[currentIndex];
                        }
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    const prevRow = row.previousElementSibling;
                    if (prevRow) {
                        const prevCells = Array.from(prevRow.querySelectorAll('td, th'));
                        if (prevCells[currentIndex]) {
                            newCell = prevCells[currentIndex];
                        }
                    }
                    break;
            }

            if (newCell) {
                selected.classList.remove('selected');
                newCell.classList.add('selected');
                newCell.focus();
                newCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });
    }

    // Convert column index to Excel column letter (1 -> A, 2 -> B, 27 -> AA, etc.)
    function indexToExcelColumn(index) {
        let result = '';
        index--; // Convert to 0-based
        while (index >= 0) {
            result = String.fromCharCode(65 + (index % 26)) + result;
            index = Math.floor(index / 26) - 1;
        }
        return result || 'A';
    }

    // Initialize Excel table enhancements when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for the table to be rendered
        setTimeout(enhanceExcelTable, 100);
    });

    // Re-enhance if table is dynamically updated
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', enhanceExcelTable);
    } else {
        enhanceExcelTable();
    }
</script>
{% endblock %}
